{% sw_extends '@Storefront/storefront/page/checkout/confirm/index.html.twig' %}

{% block page_checkout_aside %}

    {% set easyCheckoutVariables = page.extensions.easy_checkout_variables %}
    {% set easyCheckoutType = easyCheckoutVariables.checkoutType %}
    {% set easy_checkout_is_active = easyCheckoutVariables.easy_checkout_is_active %}
    {% if easyCheckoutType == 'embedded' and easy_checkout_is_active == 1 %}

        <div id="dibs-checkout-embedded">
            <div id="dibs-complete-checkout"></div>
        </div>

        {% set easyCheckoutKey = easyCheckoutVariables.checkoutKey %}
        {% set easyPaymentId = easyCheckoutVariables.paymentId %}
        {% set easyEnvironment = easyCheckoutVariables.environment %}
        {% set easyPlaceOrderUrl = easyCheckoutVariables.place_order_url %}
        {% set easyCheckoutJsAsset = easyCheckoutVariables.easy_checkout_ja_asset %}

        <script type="text/javascript" src="{{ easyCheckoutJsAsset }}"></script>

		{% set isoCode = page.header.activeLanguage.translationCode.code|lower|split('-') %}
		{% set country = isoCode[0] %}
		{% set language = isoCode[1] %}
        {% set easyLanguage = country ~ '-' ~ language %}

		{% if easyLanguage == 'en-gb' %}
            {% set eCheckoutLanguage = 'en-GB' %}
        {% elseif easyLanguage == 'da-dk' %}
            {% set eCheckoutLanguage = 'da-DK' %}
        {% elseif easyLanguage == 'sv-se' %}
            {% set eCheckoutLanguage = 'sv-SE' %}
        {% elseif easyLanguage == 'nb-no' %}
            {% set eCheckoutLanguage = 'nb-NO' %}
        {% elseif easyLanguage == 'de-de' %}
            {% set eCheckoutLanguage = 'de-DE' %}
        {% elseif easyLanguage == 'pl-pl' %}
            {% set eCheckoutLanguage = 'pl-PL' %}
        {% elseif easyLanguage == 'fr-fr' %}
            {% set eCheckoutLanguage = 'fr-FR' %}
        {% elseif easyLanguage == 'es-es' %}
            {% set eCheckoutLanguage = 'es-ES' %}
        {% elseif easyLanguage == 'nl-nl' %}
            {% set eCheckoutLanguage = 'nl-NL' %}
        {% elseif easyLanguage == 'fi-fi' %}
            {% set eCheckoutLanguage = 'fi-FI' %}
        {% else %}
            {% set eCheckoutLanguage = 'en-GB' %}
        {% endif %}

        <script>
            //<![CDATA[
            const checkoutOptions = {
                checkoutKey: '{{ easyCheckoutKey }}',
                paymentId: '{{ easyPaymentId }}',
                containerId: 'dibs-complete-checkout',
                language: '{{ eCheckoutLanguage }}'
            };

            const checkout = new Dibs.Checkout(checkoutOptions);

            checkout.on('payment-completed', function(response) {
                console.log(response);
                window.location.href = '{{ easyPlaceOrderUrl }}' + '?paymentId=' + response.paymentId;
            });

            {% if page.cart.errors|length > 0 %}
                checkout.freezeCheckout();
            {% endif %}
            //]]>
        </script>

    {% else %}
       <div id="dibs-checkout-embedded">
       </div>
    {% endif %}
    {{ parent() }}

{% endblock %}

{% block page_checkout_aside_container %}
    <div class="checkout-summary">
        {{ parent() }}
    </div>
{% endblock %}

{% block page_checkout_confirm_form_submit %}
        <button id="confirmFormSubmit"
                class="btn btn-primary btn-block btn-lg"
                form="confirmOrderForm"
            {% if page.cart.errors|length > 0 or easyCheckoutType == 'embedded' and easy_checkout_is_active == 1 %}
                disabled="disabled"
            {% endif %}
                type="submit">
            {{ "checkout.confirmSubmit"|trans|sw_sanitize }}
        </button>
{% endblock %}
